const k="modulepreload",T=function(e){return"/"+e},g={},P=function(r,t,n){let o=Promise.resolve();if(t&&t.length>0){let s=function(l){return Promise.all(l.map(f=>Promise.resolve(f).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),c=a?.nonce||a?.getAttribute("nonce");o=s(t.map(l=>{if(l=T(l),l in g)return;g[l]=!0;const f=l.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":k,f||(u.as="script"),u.crossOrigin="",u.href=l,c&&u.setAttribute("nonce",c),document.head.appendChild(u),f)return new Promise((_,E)=>{u.addEventListener("load",_),u.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(s){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s}return o.then(s=>{for(const a of s||[])a.status==="rejected"&&i(a.reason);return r().catch(i)})};function S(e){return e?`/auth/login/${e}`:"/auth/login"}var p="/",v=(e,r)=>(e.endsWith(p)&&(e=e.slice(0,-1)),r.startsWith(p)||(r=p+r),e+r),j=(e,r,t)=>{let n=e.pathname===p?r:v(e.pathname,r),o=new globalThis.URL(n,e);if(t)for(let[i,s]of Object.entries(I(t)))if(s&&typeof s=="object"&&!Array.isArray(s))for(let[a,c]of Object.entries(s))o.searchParams.set(`${i}[${a}]`,String(c));else o.searchParams.set(i,s);return o};function R(e){return typeof e!="object"||!e?!1:"headers"in e&&"ok"in e&&"json"in e&&typeof e.json=="function"&&"text"in e&&typeof e.json=="function"}async function A(e){if(!(typeof e!="object"||!e)){if(R(e)){let r=e.headers.get("Content-Type")?.toLowerCase();if(r?.startsWith("application/json")||r?.startsWith("application/health+json")){let t=await e.json();if(!e.ok||"errors"in t)throw t;return"data"in t?t.data:t}if(r?.startsWith("text/html")||r?.startsWith("text/plain")){let t=await e.text();if(!e.ok)throw t;return t}return e.status===204?null:e}if("errors"in e)throw e;return"data"in e?e.data:e}}var O=async(e,r,t=globalThis.fetch)=>(r.headers=typeof r.headers=="object"&&!Array.isArray(r.headers)?r.headers:{},t(e,r).then(n=>A(n).catch(o=>{let i={errors:o&&typeof o=="object"&&"errors"in o?o.errors:o,response:n};return o&&typeof o=="object"&&"data"in o&&(i.data=o.data),Promise.reject(i)}))),y={fetch:globalThis.fetch,WebSocket:globalThis.WebSocket,URL:globalThis.URL,logger:globalThis.console},U=(e,r={})=>{let t=r.globals?{...y,...r.globals}:y;return{globals:t,url:new t.URL(e),with(n){return{...this,...n(this)}}}};function C(e,r={}){return()=>{let t=S(r.provider),n=e;return"otp"in r&&(n.otp=r.otp),n.mode=r.mode??"cookie",{path:t,method:"POST",body:JSON.stringify(n)}}}function b(e){return["directus_access","directus_activity","directus_collections","directus_comments","directus_fields","directus_files","directus_folders","directus_migrations","directus_permissions","directus_policies","directus_presets","directus_relations","directus_revisions","directus_roles","directus_sessions","directus_settings","directus_users","directus_webhooks","directus_dashboards","directus_panels","directus_notifications","directus_shares","directus_flows","directus_operations","directus_translations","directus_versions","directus_extensions"].includes(e)}var x=(e,r,t)=>()=>{let n=String(e);if(b(n))throw new Error("Cannot use createItem for core collections");return{path:`/items/${n}`,params:t??{},body:JSON.stringify(r),method:"POST"}},D=(e,r)=>()=>({path:"/users",params:r??{},body:JSON.stringify(e),method:"POST"}),q=e=>{let r=(t,n=[])=>{if(typeof t=="object"){let o=[];for(let i in t){let s=t[i]??[];if(Array.isArray(s))for(let a of s)o.push(r(a,[...n,i]));else if(typeof s=="object")for(let a of Object.keys(s)){let c=s[a];for(let l of c)o.push(r(l,[...n,`${i}:${a}`]))}}return o.flatMap(i=>i)}return[...n,String(t)].join(".")};return e.flatMap(t=>r(t))},I=e=>{let r={};Array.isArray(e.fields)&&e.fields.length>0&&(r.fields=q(e.fields).join(",")),e.filter&&Object.keys(e.filter).length>0&&(r.filter=JSON.stringify(e.filter)),e.search&&(r.search=e.search),"sort"in e&&e.sort&&(r.sort=typeof e.sort=="string"?e.sort:e.sort.join(",")),typeof e.limit=="number"&&e.limit>=-1&&(r.limit=String(e.limit)),typeof e.offset=="number"&&e.offset>=0&&(r.offset=String(e.offset)),typeof e.page=="number"&&e.page>=1&&(r.page=String(e.page)),e.deep&&Object.keys(e.deep).length>0&&(r.deep=JSON.stringify(e.deep)),e.alias&&Object.keys(e.alias).length>0&&(r.alias=JSON.stringify(e.alias)),e.aggregate&&Object.keys(e.aggregate).length>0&&(r.aggregate=JSON.stringify(e.aggregate)),e.groupBy&&e.groupBy.length>0&&(r.groupBy=e.groupBy.join(","));for(let[t,n]of Object.entries(e))t in r||(typeof n=="string"||typeof n=="number"||typeof n=="boolean"?r[t]=String(n):r[t]=JSON.stringify(n));return r},N=(e,r)=>{if(e.length===0)throw new Error(r)},L=(e,r)=>{if(b(String(e)))throw new Error(r)},w=(e,r)=>()=>(N(String(e),"Collection cannot be empty"),L(e,"Cannot use readItems for core collections"),{path:`/items/${e}`,params:r??{},method:"GET"}),$={},W=(e={})=>r=>{let t={...$,...e};return{async request(n){let o=n();if(o.headers||(o.headers={}),"Content-Type"in o.headers?o.headers["Content-Type"]==="multipart/form-data"&&delete o.headers["Content-Type"]:o.headers["Content-Type"]="application/json","getToken"in this&&!("Authorization"in o.headers)){let c=await this.getToken();c&&(o.headers.Authorization=`Bearer ${c}`)}let i=j(r.url,o.path,o.params),s={method:o.method??"GET",headers:o.headers??{}};"credentials"in t&&(s.credentials=t.credentials),o.body&&(s.body=o.body),o.onRequest&&(s=await o.onRequest(s)),t.onRequest&&(s=await t.onRequest(s));let a=await O(i.toString(),s,r.globals.fetch);return"onResponse"in o&&(a=await o.onResponse(a,s)),"onResponse"in e&&(a=await e.onResponse(a,s)),a}}};const J="https://directus.bryanmedin4.com",d=U(J).with(W()),m=1e4;async function V(e,r){try{console.log("Intentando autenticar con Directus:",{email:e});const t=d.request(C({email:e,password:r})),n=new Promise((i,s)=>{setTimeout(()=>s(new Error("Tiempo de espera agotado al autenticar")),m)}),o=await Promise.race([t,n]);if(console.log("Resultado de autenticación:",{success:!0,hasUser:!!o.user,hasToken:!!o.access_token,hasRefreshToken:!!o.refresh_token,expires:o.expires}),!o||!o.access_token)throw new Error("Respuesta de autenticación inválida");return{success:!0,data:{access_token:o.access_token,refresh_token:o.refresh_token,expires:o.expires},user:o.user||{email:e},token:o.access_token}}catch(t){return console.error("Error de autenticación:",t),{success:!1,error:t.message||"Error al autenticar usuario"}}}async function B(){try{return await d.request(w("Vehiculo"))||[]}catch(e){return console.error("Error al obtener vehículos:",e),[]}}async function M(){try{const e={item1:["6","7","8","9","0"],item2:["1","2","3","4","5"]};return console.log("Reglas de Pico y Placa obtenidas:",e),e}catch(e){return console.error("Error al obtener reglas de pico y placa:",e),{item1:["6","7","8","9","0"],item2:["1","2","3","4","5"]}}}async function G(){try{return await d.logout(),{success:!0}}catch(e){return console.error("Error al cerrar sesión:",e),{success:!1,error:e.message||"Error al cerrar sesión"}}}async function z(e,r){try{console.log("Creando vehículo en Directus:",{placa:e,tipo:r});let t=null;if(typeof window<"u")try{const{useAuthStore:s}=await P(async()=>{const{useAuthStore:c}=await import("./auth-store.whEsov_B.js");return{useAuthStore:c}},[]),a=s.getState();if(t=a.user?.id||null,console.log("ID de usuario del store:",t),!t&&a.token)try{console.log("Intentando obtener usuario desde Directus");const c=await d.request(()=>({path:"/users/me",method:"GET"}));c&&c.id&&(t=c.id,console.log("ID de usuario obtenido desde Directus:",t))}catch(c){console.warn("No se pudo obtener el usuario desde Directus:",c)}}catch(s){console.warn("No se pudo obtener el ID del usuario del store:",s)}const n=d.request(x("Vehiculo",{Placa:e,Tipo:r,Ciudad:"1",Usuario:t})),o=new Promise((s,a)=>{setTimeout(()=>a(new Error("Tiempo de espera agotado al crear vehículo")),m)}),i=await Promise.race([n,o]);return console.log("Vehículo creado correctamente:",i),{success:!0,data:i}}catch(t){return console.error("Error al crear vehículo:",t),{success:!1,error:t.message||"Error al crear vehículo"}}}async function K(e){try{if(console.log("Creando usuario con SDK de Directus:",{...e,password:"***OCULTA***"}),!e.email||!e.password)throw new Error("El email y la contraseña son obligatorios");const r={email:e.email,password:e.password,first_name:e.first_name||"",role:"4bf867c2-ea16-4c47-a042-efe0b39ecce9"},t=d.request(D(r)),n=new Promise((i,s)=>{setTimeout(()=>s(new Error("Tiempo de espera agotado al crear usuario")),m)}),o=await Promise.race([t,n]);return console.log("Usuario creado correctamente con SDK de Directus:",{...o,password:"***OCULTA***"}),{success:!0,data:o,message:"Usuario creado exitosamente"}}catch(r){console.error("Error al crear usuario con SDK de Directus:",r);let t="Error desconocido al crear usuario";return r&&r.errors&&Array.isArray(r.errors)&&r.errors.length>0?(t=r.errors[0].message||"Error desconocido",t.includes("Duplicate entry")||t.includes("already exists")||t.includes("has to be unique")?t="El correo electrónico ya está registrado":t.includes("validation")||t.includes("Validation")?t="Error de validación: "+t:(t.includes("permission")||t.includes("Permission")||t.includes("FORBIDDEN"))&&(t="No tienes permisos para crear usuarios")):r.message&&(t=r.message,r.message.includes("Tiempo de espera agotado")&&(t="Tiempo de espera agotado al crear el usuario. Inténtalo de nuevo.")),{success:!1,error:t}}}async function F(e=null){try{console.log("Verificando autenticación con Directus");const r=d.request(w("Vehiculo",{limit:1})),t=new Promise((n,o)=>{setTimeout(()=>o(new Error("Tiempo de espera agotado")),m)});return await Promise.race([r,t]),console.log("Usuario autenticado correctamente"),{isAuthenticated:!0,tokenRefreshed:!1}}catch(r){if(console.error("Error al verificar autenticación:",r),r&&(r.message?.includes("token")||r.message?.includes("auth")||r.status===401||r.status===403)){if(console.log("Error de autenticación detectado, token posiblemente expirado"),e){console.log("Intentando refrescar token automáticamente");try{const t=await d.refresh(e);if(t&&t.access_token)return console.log("Token refrescado automáticamente con éxito"),{isAuthenticated:!0,tokenRefreshed:!0,newToken:t.access_token,newRefreshToken:t.refresh_token,expires:t.expires}}catch(t){console.error("Error al refrescar token automáticamente:",t)}}return{isAuthenticated:!1,tokenRefreshed:!1}}return console.log("Error de conexión o servidor, no se pudo verificar la autenticación"),{isAuthenticated:null,tokenRefreshed:!1}}}const H=Object.freeze(Object.defineProperty({__proto__:null,authenticateUser:V,createDirectusUser:K,createVehiculo:z,getReglasPicoYPlaca:M,getVehiculos:B,isAuthenticated:F,logoutUser:G},Symbol.toStringTag,{value:"Module"}));export{P as _,M as a,z as b,K as c,V as d,H as e,B as g,F as i,G as l};
